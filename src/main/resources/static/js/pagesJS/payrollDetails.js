var testData = {"rows": [
        {"section": "A", "sectionDescription": "Administration", "name": "Mahmood, Ileen", "ppLeft": 10, "regPayPerPP": 1000.00, "regPayToDate": 0, "overtimeToDate": 0, "regPayForecast": 10000.00, "totalFYForecast": 10000.00}
        , {"section": "Z", "sectionDescription": "Administration", "name": "Knepper, Nia", "ppLeft": 10, "regPayPerPP": 2000.00, "regPayToDate": 0, "overtimeToDate": 0, "regPayForecast": 10000.00, "totalFYForecast": 10000.00}
        , {"section": "AD", "sectionDescription": "Administration", "name": "Unger, Adam", "ppLeft": 10, "regPayPerPP": 8090.00, "regPayToDate": 0, "overtimeToDate": 0, "regPayForecast": 10000.00, "totalFYForecast": 10000.00}
        , {"section": "F", "sectionDescription": "Administration", "name": "Starkes, Tricia", "ppLeft": 10, "regPayPerPP": 100.00, "regPayToDate": 0, "overtimeToDate": 0, "regPayForecast": 10000.00, "totalFYForecast": 10000.00}
        , {"section": "AD", "sectionDescription": "Administration", "name": "Majewski, Vonda", "ppLeft": 10, "regPayPerPP": 500.00, "regPayToDate": 0, "overtimeToDate": 0, "regPayForecast": 10000.00, "totalFYForecast": 10000.00}
        , {"section": "Gd", "sectionDescription": "Administration", "name": "Work, Pauletta", "ppLeft": 10, "regPayPerPP": 10000.00, "regPayToDate": 0, "overtimeToDate": 0, "regPayForecast": 10000.00, "totalFYForecast": 10000.00}
        , {"section": "g", "sectionDescription": "Administration", "name": "Carr, Susie", "ppLeft": 10, "regPayPerPP": 5000.00, "regPayToDate": 0, "overtimeToDate": 0, "regPayForecast": 10000.00, "totalFYForecast": 10000.00}
        , {"section": "gd", "sectionDescription": "Administration", "name": "Mahar, Fay", "ppLeft": 10, "regPayPerPP": 18090.00, "regPayToDate": 0, "overtimeToDate": 0, "regPayForecast": 10000.00, "totalFYForecast": 10000.00}
        , {"section": "AD", "sectionDescription": "Administration", "name": "Dederick, Mindy", "ppLeft": 10, "regPayPerPP": 1200.00, "regPayToDate": 0, "overtimeToDate": 0, "regPayForecast": 10000.00, "totalFYForecast": 10000.00}
        , {"section": "G", "sectionDescription": "Administration", "name": "Vanalstyne, Silas", "ppLeft": 10, "regPayPerPP": 1400.00, "regPayToDate": 0, "overtimeToDate": 0, "regPayForecast": 10000.00, "totalFYForecast": 10000.00}
        , {"section": "AD", "sectionDescription": "Administration", "name": "Clemons, Lyla", "ppLeft": 10, "regPayPerPP": 170.00, "regPayToDate": 0, "overtimeToDate": 0, "regPayForecast": 10000.00, "totalFYForecast": 10000.00}
        , {"section": "AD", "sectionDescription": "Administration", "name": "Hinson, Deangelo", "ppLeft": 10, "regPayPerPP": 1300.00, "regPayToDate": 0, "overtimeToDate": 0, "regPayForecast": 10000.00, "totalFYForecast": 10000.00}
        , {"section": "AD", "sectionDescription": "Administration", "name": "Kriebel, Lee", "ppLeft": 10, "regPayPerPP": 1000.00, "regPayToDate": 0, "overtimeToDate": 0, "regPayForecast": 10000.00, "totalFYForecast": 10000.00}
        , {"section": "AD", "sectionDescription": "Administration", "name": "Teasdale, Prince", "ppLeft": 10, "regPayPerPP": 1000.00, "regPayToDate": 0, "overtimeToDate": 0, "regPayForecast": 10000.00, "totalFYForecast": 10000.00}
        , {"section": "AD", "sectionDescription": "Administration", "name": "Espinal, Geralyn", "ppLeft": 10, "regPayPerPP": 1000.00, "regPayToDate": 0, "overtimeToDate": 0, "regPayForecast": 10000.00, "totalFYForecast": 10000.00}
        , {"section": "B", "sectionDescription": "Administration", "name": "Kirchoff, Isiah", "ppLeft": 10, "regPayPerPP": 1000.00, "regPayToDate": 0, "overtimeToDate": 0, "regPayForecast": 10000.00, "totalFYForecast": 10000.00}
        , {"section": "B", "sectionDescription": "Administration", "name": "Lovell, Hector", "ppLeft": 10, "regPayPerPP": 1000.00, "regPayToDate": 0, "overtimeToDate": 0, "regPayForecast": 10000.00, "totalFYForecast": 10000.00}
        , {"section": "B", "sectionDescription": "Administration", "name": "Rennie, Kara", "ppLeft": 10, "regPayPerPP": 1000.00, "regPayToDate": 0, "overtimeToDate": 0, "regPayForecast": 10000.00, "totalFYForecast": 10000.00}
        , {"section": "B", "sectionDescription": "Administration", "name": "Crick, Eleanore", "ppLeft": 10, "regPayPerPP": 1000.00, "regPayToDate": 0, "overtimeToDate": 0, "regPayForecast": 10000.00, "totalFYForecast": 10000.00}
        , {"section": "B", "sectionDescription": "Administration", "name": "Bradsher, Alphonso", "ppLeft": 10, "regPayPerPP": 1000.00, "regPayToDate": 0, "overtimeToDate": 0, "regPayForecast": 10000.00, "totalFYForecast": 10000.00}
        , {"section": "B", "sectionDescription": "Administration", "name": "Prewitt, Ressie", "ppLeft": 10, "regPayPerPP": 1000.00, "regPayToDate": 0, "overtimeToDate": 0, "regPayForecast": 10000.00, "totalFYForecast": 10000.00}
        , {"section": "A", "sectionDescription": "Administration", "name": "Glynn, Von", "ppLeft": 10, "regPayPerPP": 1000.00, "regPayToDate": 0, "overtimeToDate": 0, "regPayForecast": 10000.00, "totalFYForecast": 10000.00}
        , {"section": "A", "sectionDescription": "Administration", "name": "Desoto, Dagmar", "ppLeft": 10, "regPayPerPP": 1000.00, "regPayToDate": 0, "overtimeToDate": 0, "regPayForecast": 10000.00, "totalFYForecast": 10000.00}
        , {"section": "A", "sectionDescription": "Administration", "name": "Fonte, Kittie", "ppLeft": 10, "regPayPerPP": 10000.00, "regPayToDate": 0, "overtimeToDate": 0, "regPayForecast": 10000.00, "totalFYForecast": 10000.00}
        , {"section": "A", "sectionDescription": "Administration", "name": "Philpot, Genoveva", "ppLeft": 10, "regPayPerPP": 5000.00, "regPayToDate": 0, "overtimeToDate": 0, "regPayForecast": 10000.00, "totalFYForecast": 10000.00}
        , {"section": "A", "sectionDescription": "Administration", "name": "Ferber, Jewell", "ppLeft": 10, "regPayPerPP": 1500.00, "regPayToDate": 0, "overtimeToDate": 0, "regPayForecast": 10000.00, "totalFYForecast": 10000.00}
        , {"section": "A", "sectionDescription": "Administration", "name": "Cremer, Jacalyn", "ppLeft": 10, "regPayPerPP": 5000.00, "regPayToDate": 0, "overtimeToDate": 0, "regPayForecast": 10000.00, "totalFYForecast": 10000.00}
        , {"section": "A", "sectionDescription": "Administration", "name": "Neill, Chantal", "ppLeft": 10, "regPayPerPP": 1030.00, "regPayToDate": 0, "overtimeToDate": 0, "regPayForecast": 10000.00, "totalFYForecast": 10000.00}
        , {"section": "AD", "sectionDescription": "Administration", "name": "Lamberton, Nakita", "ppLeft": 10, "regPayPerPP": 1010.00, "regPayToDate": 0, "overtimeToDate": 0, "regPayForecast": 10000.00, "totalFYForecast": 10000.00}
        , {"section": "AD", "sectionDescription": "Administration", "name": "Dobson, Veronika", "ppLeft": 10, "regPayPerPP": 8000.00, "regPayToDate": 0, "overtimeToDate": 0, "regPayForecast": 10000.00, "totalFYForecast": 10000.00}
        , {"section": "AD", "sectionDescription": "Administration", "name": "Stockdale, Jalisa", "ppLeft": 10, "regPayPerPP": 1000.00, "regPayToDate": 0, "overtimeToDate": 0, "regPayForecast": 10000.00, "totalFYForecast": 10000.00}
    ]};
var useTestData = false;

$(document).ready(function () {
    var api = '';

    $('#payrollSub').addClass('show');
    $('#payrollSub > li:nth-child(2) > a').addClass('highlight');

    $('#payroll thead th:nth-child(1)').html('<label class="headLabel" for="sec">Section</label><input type="text" id="sec" class="headSearch" placeholder="Search Section" />');
    $('#payroll thead th:nth-child(2)').html('<label class="headLabel" for="name">Name Code</label><input type="text" id="name" class="headSearch" placeholder="Search Name Code" />');

    $.ajax({
        type: 'GET',
        url: api + '/jobCode',
        success: function (json) {
            $('#jobcode').append(json.map(function (jc) {
                var selected = "";
                if (jc.jobCode.match(/^FRFI38\d\d$/)) {
                    console.log("Matched " + jc.jobCode);
                    selected = " selected"
                }
                return '<option value="' + jc.id + '"id="' + jc.id + '"' + selected + '>' + jc.jobCode + '</option>';
            }));
        }
    }); //end of get jobcode ajax call
    $.ajax({
        type: 'GET',
        url: api + '/payrollDetails/json',
        success: function (json) {
            console.log(json);
            populateDataTable(useTestData ? testData : json); // test data vs live data
        }
    });

    function populateDataTable(jsonData) {
        var currency = $.fn.dataTable.render.number(',', '.', 0, '$');
        var dt = $('#payroll').DataTable({
            dom: 'Brtip',
            bProcessing: true,
            bPaginate: false,
            buttons: [
                {
                    text: 'Print <i class="fa fa-lg fa-print"></i>',
                    extend: 'print',
                    exportOptions: {
                        columns: [0, 1, 2, 3, 4, 5, 6, 7]
                    },
                    className: 'table-btns print-btn'
                },
                {
                    text: 'Export to Excel <i class="fa fa-lg fa-file-excel-o"></i>',
                    extend: 'excel',
                    exportOptions: {
                        columns: [0, 1, 2, 3, 4, 5, 6, 7]
                    },
                    className: 'table-btns excel-btn'
                },
                {
                    text: 'Add <i class="fa fa-lg fa-plus"></i>',
                    action: function () {
                        window.location.href = './newSalary.html';
                    },
                    className: 'table-btns add-btn'
                },
                {
                    text: 'Refresh <i class="fa fa-lg fa-repeat"></i>',
                    action: function () {
                        window.location.reload();
                    },
                    className: 'table-btns refresh-btn'
                }

            ],
            data: jsonData.rows,
            columnDefs: {sortable: false, targets: [8]},
            columns: [
                {data: "section", orderData: [0, 1]},
                {data: "name"},
                {data: "ppLeft"},
                {data: "regPayPerPP",
                    "render": $.fn.dataTable.render.number(',', '.', 0, '$')
                },
                {data: "regPayToDate",
                    "render": $.fn.dataTable.render.number(',', '.', 0, '$')
                },
                {data: "overtimeToDate",
                    "render": $.fn.dataTable.render.number(',', '.', 0, '$')
                },
                {data: null,
                    "render": function (data, type, full, meta) {
                        var amount = data.ppLeft * data.regPayPerPP;
                        return $.fn.dataTable.render.number(',', '.', 0, '$').display(amount);
                    }
                },
                {data: null,
                    "render": function (data, type, full, meta) {
                        var projected = data.ppLeft * data.regPayPerPP;
                        var amount = parseInt(data.regPayToDate) + parseInt(projected);
                        return $.fn.dataTable.render.number(',', '.', 0, '$').display(amount);
                    }
                },

                {data: null,
                    "render": function (data, type, full, meta) {
                        return `
                        <div>
                            <div class="dropdown1">
                            <button class="dropbtn1"><i class="fa fa-ellipsis-v"></i></button>
                            <div class="dropdown-content1">
                            <a data-target="#myModal" href="#myModal" class="editBtn" data-id="${full.employeeProfileId}">Edit Pay</a>
                            </div>
                        </div>
                    </div>
                        `
                    },
                    "sortable": false,
                    "orderable": false
                }
            ],
        });

        dt.columns().every(function () {
            var that = this;
            $('input', this.header(2)).on('keyup change', function () {
                if (that.search() !== this.value) {
                    that
                            .search(this.value)
                            .draw();
                }
            });
        });

        $('#payroll #totalRegPayToDate').html(currency.display(jsonData.totalRegPayToDate));
        $('#payroll #totalOvertimeToDate').html(currency.display(jsonData.totalOvertimeToDate));
        $('#payroll #totalRegPayForecast').html(currency.display(jsonData.totalRegPayForecast));
        $('#payroll #grandTotalFYForecast').html(currency.display(jsonData.grandTotalFYForecast));

    }
    $('#payroll tbody').on('click', '.editBtn', function () {
        var employeeID = $(this).data("id");
        $.ajax({
            type: 'GET',
            url: api + '/employeeProfile/' + employeeID,
            success: function (data) {
                $('#myModal #empFirstName').val(data.firstName);
                $('#myModal #empLastName').val(data.lastName);
                $('#myModal #empPPLeft').val(data.payPeriodsLeft);
                $('#myModal #empRegPay').val(data.regPayPerPayPeriod);
                $("#empID").data(data);
            }
        });
        $('#myModal').modal('show');
    });

    $("#editForm").submit(function () {
        var pd = $("#empID").data();
        pd.payPeriodsLeft = parseInt($('#myModal #empPPLeft').val());
        pd.regPayPerPayPeriod = parseInt($('#myModal #empRegPay').val());
        pd.firstName = $('#myModal #empFirstName').val();
        pd.lastName = $('#myModal #empLastName').val();
        var id = parseInt($('#empID').data('id'));

        console.log(pd);
        console.log(id);

        $.ajax({
            type: "POST",
            contentType: "application/json",
            url: "/employeeProfile",
            data: JSON.stringify(pd),
            dataType: 'json',
            cache: false,
            timeout: 600000,
            success: function (data) {
                $('#myModal').modal('hide');
                $('#success').show();
                $('#success').delay(5000).fadeOut();
                window.location.href = api + '/payrollDetails';
            },
            error: function (request, status, error) {
                console.log(request.responseJSON);
                $('#myModal').modal('hide');
                $('#error').show()
                $('#error').delay(5000).fadeOut();
                //window.location.href = api + '/payrollDetails';
            }
        });
        return false;
    });
});